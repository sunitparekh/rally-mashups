<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>Scrum Board Mashup by sUnit, ThoughtWorks Inc.</title>

    <script charset="utf-8" src="/slm/pack/combined.js.h-1314550004.pack" type="text/javascript"></script>
    <script type="text/javascript" src="/slm/js-lib/dojo/1.3.1/dojo/dojo.js"></script>
    <script type="text/javascript" src="/slm/mashup/1.14/js/batch-toolkit.js"></script>
    <script type="text/javascript" src="/slm/mashup/1.14/js/utilities.js"></script>
    <script type="text/javascript" src="/slm/mashup/1.14/js/dropdown.js"></script>

    <link rel="stylesheet" type="text/css" href="http://real.us.yimg.com/lib/yui/3.0.0/build/cssreset/reset-min.css"/>
    <script src="http://yui.yahooapis.com/3.0.0/build/yui/yui-min.js"></script>

    <style type="text/css">
        .outer-container {
    width: 1900px;
    font-family: arial, verdana, geneva, sans-serif;
    font-size: 0.75em;
}

.left {
    float: left;
}

.right {
    float: right;
}

.hide {
    display:none;
}

#error-message {
    width:100%;
    background-color: #ccffcc;
    color: red;
    padding: 2px 10px;
    clear:both;
}

#flash-message {
    text-align: center;
    width:600px;
    background-color: #ccffcc;
    padding: 2px 10px;
}

.navigation-bar {
    margin: 5px 20px;
    height: 20px;
}
.navigation-bar select{
    margin: 0 5px;
}

.menu-bar {
    margin: 0 10px;
}

.swimlane-board {
    margin-top: 15px;
}

.swimlane-row {
    clear: both;
    margin: 0;
    padding: 0;
}

.swimlane {
    float: left;
    width: 150px;
    border-right: 2px solid;
}

.swimlane-cards .swimlane {
    height: 1000px;
}

.swimlane .name, .swimlane .estimate {
    text-align: center;
}

.swimlane-not-available .name {
    color: red;
}

.swimlane .estimate {
    color: green;
}

.yui-dd-drop-over {
    background-color: #FFA928;
}

.card {
    width: 135px;
    margin: 5px 5px;
    border: solid 1px black;
    border-left-width: 5px;
    font-size: 0.9em;
    overflow: hidden;
    cursor: move;
    float: left;
}

.story {
    border-left-color: blue;
}

.defect {
    border-left-color: orange;
}

.card .header {
    clear: both;
}

.card .number {
    text-align: left;
    text-decoration:underline;
    width: 85px;
    background: #B5D8EB;
    padding: 1px 5px;
    float: left;
    cursor: pointer;
}

.card .estimate {
    background: gray;
    color: white;
    width: 15px;
    padding: 1px 3px;
    float: left;
    text-align: center;
}

.card .state {
    width: 15px;
    background: #006600;
    color: white;
    float: left;
    padding: 1px 2px;
    text-align: center;
}

.card .blocked-true {
    background: red;
}

.card .title {
    padding: 2px 5px;
}

.card .selected {
    background-color: #ffcccc;
}

.card .owner {
    text-align: left;
    width: 140px;
    background: #B5D8EB;
    padding: 1px 5px;
    float: left;
    overflow: hidden;
}

    </style>
    <script type="text/javascript">
        YUI.add('mashups-global',function(Y){
    Y.namespace('Mashups.Constants');

    Y.Mashups.Constants.CARD_NAME_LENGTH = 70;
    Y.Mashups.Constants.BaseUrl = "/";

    Y.namespace('Mashups.Data');

    String.prototype.htmlID = function() {
        return this.replace(/ /g, '-').replace(/\./g,"-");
    };

    Y.namespace('Mashups');

    function FlashMessage(data) {
        FlashMessage.superclass.constructor.apply(this, arguments);
    }

    FlashMessage.NAME = 'FlashMessage';
    FlashMessage.ATTRS = { id: { value: "flash-message"} };

    Y.extend(FlashMessage, Y.Base, {
        show: function(message) {
            var flashMessage = Y.one("#" + this.get('id'));
            if (flashMessage == null || flashMessage == undefined) return;
            flashMessage.set("innerHTML",message);
            flashMessage.removeClass("hide");
        },

        hide: function() {
            var flashMessage = Y.one("#" + this.get('id'));
            if (flashMessage == null || flashMessage == undefined) return;
            flashMessage.set("innerHTML","");
            flashMessage.addClass("hide");
        }
    });

    Y.Mashups.FlashMessage = FlashMessage;

    Y.Mashups.FlashMessage.message = new Y.Mashups.FlashMessage();
    Y.Mashups.FlashMessage.error = new Y.Mashups.FlashMessage({ id: "error-message"});

},'1.0',{requires: ['base']});YUI.add('mashups-action-menu', function(Y) {
    Y.namespace('Mashups');

    function ActionMenu(config) {
        ActionMenu.superclass.constructor.apply(this, arguments);
    }

    ActionMenu.NAME = 'action-menu';
    ActionMenu.ATTRS = { id: { value: "action-menu"}, showSwimlane: {value: true}, hideSwimlane: {value: true}, moveToIteration: {value: true} };

    Y.extend(ActionMenu, Y.Base, {
        initializer: function(config) {
        },

        buildMenu: function(swimlanes, service) {
            this.clear();
            var mainMenuNode = Y.Node.create("<ul></ul>");
            Y.one(".yui-menu-content").appendChild(mainMenuNode);

            this.buildShowSwimlaneActionMenu(swimlanes, mainMenuNode);
            this.buildHideSwimlaneActionMenu(swimlanes, mainMenuNode);

            this.buildMoveToIterationMenu(service, mainMenuNode, swimlanes);
        },

        applyYuiMenu: function() {
            var menu = Y.one("#" + this.get('id'));
            menu.plug(Y.Plugin.NodeMenuNav);
        },

        buildShowSwimlaneActionMenu: function(swimlanes, mainMenuNode) {
            if (this.get("showSwimlane"))
                this.buildSwimlaneActionmenu(swimlanes,mainMenuNode,"Show Swimlane","show-swimlane", function(swimlane) {swimlane.show();});
        },

        buildHideSwimlaneActionMenu: function(swimlanes, mainMenuNode) {
            if (this.get("hideSwimlane"))
                this.buildSwimlaneActionmenu(swimlanes,mainMenuNode,"Hide Swimlane","hide-swimlane", function(swimlane) {swimlane.hide();});
        },

        buildSwimlaneActionmenu: function(swimlanes, mainMenuNode, mainMenuLabel, subMenuId, onclickCallback) {
            var showSwimlaneMainMenuNode = Y.Node.create("<li></li>");
            showSwimlaneMainMenuNode.append("<a class=\"yui-menu-label\" href=\"#" + subMenuId +"\"><em>" + mainMenuLabel + "</em></a>");
                var showSwimlaneSubMenu = Y.Node.create("<div id=\"" + subMenuId +"\" class=\"yui-menu\"></div>");
                    var swimlaneSubMenuContent = Y.Node.create("<div class=\"yui-menu-content\"></div>");
                        var swimlaneSubMenuUl = Y.Node.create("<ul></ul>");
                            Y.each(swimlanes.swimlanes, function(swimlane) {
                                if (swimlane.isHidden()) { swimlane.hide(); }
                                var showSwimlaneLi = Y.Node.create('<li class="yui-menuitem"></li>');
                                    var swimlaneMenuItemAction = Y.Node.create("<a class=\"yui-menuitem-content\" href=\"#\">" + swimlane.Label + "</a>");
                                    swimlaneMenuItemAction.on("click",function() { onclickCallback(swimlane)});
                                    showSwimlaneLi.appendChild(swimlaneMenuItemAction);
                                swimlaneSubMenuUl.appendChild(showSwimlaneLi);
                            });
                        swimlaneSubMenuContent.appendChild(swimlaneSubMenuUl);
                showSwimlaneSubMenu.appendChild(swimlaneSubMenuContent);

                showSwimlaneMainMenuNode.appendChild(showSwimlaneSubMenu);
            mainMenuNode.appendChild(showSwimlaneMainMenuNode);
        },

        buildMoveToIterationMenu: function(service, mainMenuNode, swimlanes) {
            if (!this.get('moveToIteration')) { this.applyYuiMenu(); return; }

            var showSwimlaneMainMenuNode = Y.Node.create("<li></li>");
            showSwimlaneMainMenuNode.append("<a class=\"yui-menu-label\" href=\"#move-to-iteration\"><em>Move to Iteration</em></a>");
                var showSwimlaneSubMenu = Y.Node.create("<div id=\"move-to-iteration\" class=\"yui-menu\"></div>");
                    var swimlaneSubMenuContent = Y.Node.create("<div class=\"yui-menu-content\"></div>");
                        var swimlaneSubMenuUl = Y.Node.create("<ul></ul>");
                        swimlaneSubMenuContent.appendChild(swimlaneSubMenuUl);
                showSwimlaneSubMenu.appendChild(swimlaneSubMenuContent);
                showSwimlaneMainMenuNode.appendChild(showSwimlaneSubMenu);
            mainMenuNode.appendChild(showSwimlaneMainMenuNode);

            var self = this;
            var url = '/slm/webservice/1.14/iteration.js?query=(Project.ObjectID = "' + __PROJECT_OID__ + '")&fetch=true&order=StartDate&start=1&pagesize=100';
            var config = {
                method: 'GET',
                headers: { 'Content-Type': 'application/json; charset=utf-8' },
                on: {
                    success: function (x, o) {
                        var response = Y.JSON.parse(o.responseText);
                        var iterations = response['QueryResult']['Results'];
                        Y.each(iterations, function(iteration){
                            var showSwimlaneLi = Y.Node.create('<li class="yui-menuitem"></li>');
                                var swimlaneMenuItemAction = Y.Node.create("<a class=\"yui-menuitem-content\" href=\"#\">" + iteration.Name + "</a>");
                                swimlaneMenuItemAction.on("click", function(e, iteration) {
                                    var cardNodes = Y.all(".card .selected");
                                    if (cardNodes.size() == 0) Y.Mashups.FlashMessage.message.show("No cards selected. Toggle card selection by clicking on card.");
                                    Y.each(cardNodes, function(cardTitleNode, index, array) {
                                        var cardNode = cardTitleNode.ancestor(function(parentNode){return parentNode.hasClass("card");});
                                        Y.Mashups.FlashMessage.message.show("Please wait... moving selected card(s) to iteration '" + iteration.Name + "'.");
                                        var card = swimlanes.findCardByObjectID(cardNode.getAttribute("id").substring("card-".length));
                                        var callback = (index == (array.size() - 1)) ? undefined : function(){};
                                        card.update('{ "Iteration" : ' + iteration.ObjectID +' }', callback);
                                    }, iteration);

                                },{}, iteration);
                                showSwimlaneLi.appendChild(swimlaneMenuItemAction);
                            swimlaneSubMenuUl.appendChild(showSwimlaneLi);
                        });
                        self.applyYuiMenu();
                    }
                }
            };

            service.execute(url, config);
        },

        show: function() {
            var menu = Y.one("#" + this.get('id'));
            if (menu == null || menu == undefined) return;
            menu.removeClass("hide");
        },

        hide: function() {
            var menu = Y.one("#" + this.get('id'));
            if (menu == null || menu == undefined) return;
            menu.addClass("hide");
        },

        clear: function() {
            Y.one(".yui-menu-content").set("innerHTML","");
        }
    });

    Y.Mashups.ActionMenu = ActionMenu;

}, '1.0', {requires: ['base','node','node-menunav']});YUI.add('mashups-card', function(Y) {
    Y.namespace('Mashups');

    function Card(data) {
        Card.superclass.constructor.apply(this, arguments);
    }

    Card.NAME = 'card';
    Card.ATTRS = {
        type: { value: "card"},
        service: {value : null }
    };

    Y.extend(Card, Y.Base, {
        initializer: function(data) {
            var self = this;
            Y.each(data, function(value, index, array) {
                self[index] = value;
            });
        },

        cardID: function() {
            return "card-" + this.ObjectID;
        },

        render: function() {
            var cardNode = Y.Node.create("<div></div>");
            cardNode.addClass("card");
            cardNode.addClass(this.get('type'));
            cardNode.setAttribute("id", this.cardID());
                var headerNode = Y.Node.create("<div></div>");
                headerNode.addClass("header");
                    var number = Y.Node.create("<div></div>");
                    number.addClass("number");
                    number.setContent(this.FormattedID);
                    number.on("click", function(e,card){card.editCard();} ,{},this);
                headerNode.appendChild(number);
                    var estimate = Y.Node.create("<div></div>");
                    estimate.addClass("estimate");
                    estimate.setContent(this.estimate());
                headerNode.appendChild(estimate);
                    var state = Y.Node.create("<div></div>");
                    state.addClass("state");
                    state.addClass('blocked-' + this.Blocked);
                    state.setContent(this.scheduleStateLegend());
                headerNode.appendChild(state);
            cardNode.appendChild(headerNode);
                var titleNode = Y.Node.create("<div></div>");
                titleNode.addClass("title");
                titleNode.setAttribute("title","click to toggle card selection");
                titleNode.setContent(this.truncatedName());
                titleNode.on("click", function(e,card){card.toggleSelection();} ,{},this);
            cardNode.appendChild(titleNode);
                var footerNode = Y.Node.create("<div></div>");
                footerNode.addClass("footer");
                    var owner = Y.Node.create("<div></div>");
                    owner.addClass("owner");
                    owner.setContent(this.ownerName());
                footerNode.appendChild(owner);
            cardNode.appendChild(footerNode);
            return cardNode;
        },

        editCard: function(){
            var url = '/slm/awp/edit.sp?oid=' + this.ObjectID +  '&typeDefName=' + this.get('editCardRallyType');
            window.popup(url, 800, 600, 'littleN');
            return false;
        },

        toggleSelection: function() {
            Y.one("#" + this.cardID()).one(".title").toggleClass("selected");
        },

        truncatedName: function() {
            if (this.Name.length <= Y.Mashups.Constants.CARD_NAME_LENGTH) return this.Name;
            return this.Name.substring(0, Y.Mashups.Constants.CARD_NAME_LENGTH) + '...';
        },

        ownerName: function() {
            if (this.Owner == null || this.Owner == "") return "&nbsp;";
            var ownerName = Y.Cookie.getSub("email-name",this.Owner);
            if (ownerName != null) return ownerName;
            this.get('service').findOwnerNameByEmailId(this);
            return this.Owner;
        },

        updateOwnerName: function(ownerName) {
            Y.Cookie.setSub("email-name",this.Owner, ownerName, { expires: new Date("January 12, 2025") });
            Y.one("#" + this.cardID()).one(".owner").setContent(ownerName);
        },
        
        estimate: function() {
            if (this.PlanEstimate == null) return "&nbsp;";
            return this.PlanEstimate;
        },

        scheduleStateLegend: function() {
            switch (this.ScheduleState) {
                case 'Backlog': return 'B';
                case 'Defined': return 'D';
                case 'In-Progress': return 'P';
                case 'Completed': return 'C';
                case 'Accepted': return 'A';
            }
        },

        update: function(data, callback) {
            var jsonData = '{"' + this.get('rallyType') + '": ' + data + "}";
            this.get('service').updateCard(this, jsonData, callback);
        }
    });
    
    Y.Mashups.Card = Card;
    Y.Mashups.Card.sortByRank = function (a, b) {
        return (a.Rank - b.Rank);
    };

    // Story
    function Story(data) {
        Story.superclass.constructor.apply(this, arguments);
    }

    Story.NAME = 'story';
    Story.ATTRS = { type: { value: "story"}, rallyType: { value: "HierarchicalRequirement"}, editCardRallyType: { value: "Hierarchical Requirement"}};
    Y.extend(Story, Y.Mashups.Card, {

    });

    // Defect
    function Defect(data) {
        Defect.superclass.constructor.apply(this, arguments);
    }

    Defect.NAME = 'defect';
    Defect.ATTRS = { type: { value: "defect"}, rallyType: { value: "Defect"}, editCardRallyType: { value: "Defect"}};
    Y.extend(Defect, Y.Mashups.Card, {

    });


    Y.Mashups.Story = Story;
    Y.Mashups.Defect = Defect;

    // Collection
    function Cards(config) {
        Cards.superclass.constructor.apply(this, arguments);
    }

    Cards.NAME = 'cards';
    Cards.ATTRS = {};

    Y.extend(Cards, Y.Base, {
        addCard: function(card) {
            if (this.cards == null) this.cards = new Array();
            this.cards = this.cards.concat(card);
            return this;
        },

        findByObjectID : function(cardObjectID) {
            if (this.cards == null) return;
            return Y.Array.find(this.cards, function(card) {
                return (card.ObjectID == cardObjectID);
            });
        },
        noOfCards: function() {
            if (this.cards == null) return 0;
            return this.cards.length;
        },

        sortByRank: function() {
            this.cards.sort(Y.Mashups.Card.sortByRank);
        },

        indexOf: function(index) {
            return this.cards[index];
        }
    });
    Y.Mashups.Cards = Cards;

}, '1.0', {requires: ['base','node','io','json','dd','cookie','collection','mashups-global','mashups-service']});YUI.add('mashups-swimlane', function(Y) {
    Y.namespace('Mashups');

    function Swimlane(data) {
        Swimlane.superclass.constructor.apply(this, arguments);
    }

    Swimlane.NAME = 'swimlane';
    Swimlane.ATTRS = {};

    Y.extend(Swimlane, Y.Base, {
        initializer: function(data) {
            var self = this;
            Y.each(data, function(value, index, array) {
                self[index] = value;
            });
            if (this.Label == null) this.Label = this.Name;
            this.estimate = 0.0;
        },

        htmlID: function() {
            return this.Name.htmlID();
        },

        headerID: function() {
            return "header-" + this.htmlID();
        },

        footerID: function() {
            return "footer-" + this.htmlID();
        },

        cardsID: function() {
            return "cards-" + this.htmlID();
        },

        renderHeaderRow: function(id, swimlaneNotAvailableFlag) {
            var swimlaneNode = Y.Node.create("<div></div>");
            swimlaneNode.addClass("swimlane");
            if (swimlaneNotAvailableFlag) swimlaneNode.addClass("swimlane-not-available");
            swimlaneNode.setAttribute("id", id);
            var swimlaneName = Y.Node.create("<div></div>");
            swimlaneName.addClass("name");
            swimlaneName.set("innerHTML", this.Label);
            swimlaneNode.appendChild(swimlaneName);

            var swimlaneTotalEstimate = Y.Node.create("<div></div>");
            swimlaneTotalEstimate.addClass("estimate");
            swimlaneTotalEstimate.set("innerHTML", 0);
            swimlaneNode.appendChild(swimlaneTotalEstimate);
            return swimlaneNode;
        },

        renderCardsRow: function() {
            var swimlaneNode = Y.Node.create("<div></div>");
            swimlaneNode.addClass("swimlane");
            swimlaneNode.setAttribute("id", this.cardsID());
            return swimlaneNode;
        },

        move: function(card) {
            Y.Mashups.FlashMessage.message.show("Please wait.. moving card '" + card.FormattedID + "' to swimlane '" + this.Label + "'");
            card.update(this.data);
        },

        show: function() {
            Y.one("#" + this.headerID()).removeClass("hide");
            Y.one("#" + this.cardsID()).removeClass("hide");
            Y.one("#" + this.footerID()).removeClass("hide");
            Y.Cookie.removeSub(this.get("service").get("mashupName") + ".swimlanes",this.Name, { removeIfEmpty: true });
        },

        hide: function() {
            Y.one("#" + this.headerID()).addClass("hide");
            Y.one("#" + this.cardsID()).addClass("hide");
            Y.one("#" + this.footerID()).addClass("hide");
            Y.Cookie.setSub(this.get("service").get("mashupName") + ".swimlanes",this.Name,"hide", { expires: new Date("January 12, 2025") });
        },

        isHidden: function() {
            return (Y.Cookie.getSub(this.get("service").get("mashupName") + ".swimlanes",this.Name) == "hide");
        }
    });
    Y.Mashups.Swimlane = Swimlane;

    // Collection
    function Swimlanes(config) {
        Swimlanes.superclass.constructor.apply(this, arguments);
    }

    Swimlanes.NAME = 'swimlanes';
    Swimlanes.ATTRS = {
        swimlaneNotAvailable : { value : new Y.Mashups.Swimlane({ Name: "Undefined"}) },
        swimlaneKey: { value: 'KanbanState'},
        service: { value : null }
    };

    Y.extend(Swimlanes, Y.Base, {
        initializer: function(config) {
            this.cards = new Y.Mashups.Cards();
        },

        swimlaneKeyValue: function(card) {
            var keyParts = this.get("swimlaneKey").split(".");
            var keyValue = card;
            Y.each(keyParts, function(keyPart) {
                if (keyValue == null) return;
                keyValue = keyValue[keyPart];
            });
            return keyValue;
        },

        addSwimlane: function(swimlane) {
            if (this.swimlanes == null) this.swimlanes = new Array(this.get('swimlaneNotAvailable'));
            this.swimlanes = this.swimlanes.concat(swimlane);
            return this;
        },

        noOfSwimlanes: function() {
            return this.swimlanes.length;
        },

        findByName: function(swimlaneName, returnThisIfNotFound) {
            var swimlaneFound = Y.Array.find(this.swimlanes, function(swimlane) {
                return (swimlane.Name == swimlaneName);
            });
            if (swimlaneFound == null) {
                if (returnThisIfNotFound === undefined) returnThisIfNotFound = this.get("swimlaneNotAvailable");
                swimlaneFound = returnThisIfNotFound;
            }
            return swimlaneFound;
        },

        findByHtmlID: function(htmlID) {
            return Y.Array.find(this.swimlanes, function(swimlane) {
                return (swimlane.htmlID() == htmlID);
            });
        },

        findCardByObjectID: function(cardObjectID) {
            return this.cards.findByObjectID(cardObjectID);
        },

        indexOf: function(index) {
            return this.swimlanes[index];
        },

        renderSwimlanes: function() {
            this.clearSwimlanes();
            var swimlaneHeader = Y.one(".swimlane-header");
            var swimlaneCards = Y.one(".swimlane-cards");
            var swimlaneFooter = Y.one(".swimlane-footer");
            var self = this;
            Y.each(this.swimlanes, function(swimlane) {
                swimlane.set('service',self.get("service"));
                var swimlaneNotAvailableFlag = (swimlane === self.get("swimlaneNotAvailable"));

                swimlaneHeader.append(swimlane.renderHeaderRow(swimlane.headerID(), swimlaneNotAvailableFlag));

                var cardsRowNode = swimlane.renderCardsRow();
                if (swimlane != self.get('swimlaneNotAvailable')) {
                    cardsRowNode.plug(Y.Plugin.Drop);
                    cardsRowNode.drop.on('drop:hit', function(element) {
                        var newSwimlane = self.findByHtmlID(element.drop.get('node').getAttribute("id").substring("cards-".length));
                        var card = self.findCardByObjectID(element.drag.get('node').getAttribute("id").substring("card-".length));
                        if (newSwimlane.Name == self.swimlaneKeyValue(card)) { Y.Mashups.FlashMessage.message.show('Card moved into same swimlane. No updates.'); return; }
                        newSwimlane.move(card);
                    });
                }
                swimlaneCards.append(cardsRowNode);

                swimlaneFooter.append(swimlane.renderHeaderRow(swimlane.footerID(), swimlaneNotAvailableFlag));
            });
        },

        clearSwimlanes : function() {
            Y.one(".swimlane-header").set("innerHTML", "");
            Y.one(".swimlane-footer").set("innerHTML", "");
            Y.one(".swimlane-cards").set("innerHTML", "");
        },

        clearCards : function() {
            var self = this;
            this.cards = new Y.Mashups.Cards();
            Y.each(this.swimlanes, function(swimlane) {
                Y.one("#" + swimlane.cardsID()).set("innerHTML", "");
                swimlane.estimate = 0.0;
                self.updateEstimate(swimlane, 0.0);
            });
        },

        renderCard : function(card) {
            var keyValue = this.swimlaneKeyValue(card);
            var swimlane = this.findByName(keyValue);
            this.cards.addCard(card);
            var swimlaneCardsNode = Y.one("#" + swimlane.cardsID());

            var cardNode = card.render();
            cardNode.plug(Y.Plugin.Drag);
            swimlaneCardsNode.append(cardNode);

            this.updateEstimate(swimlane, card.PlanEstimate);
        },

        renderCards : function (cards) {
            this.clearCards();
            var self = this;
            Y.each(cards.cards, function(card) {
                card.set('service', self.get('service'));
                self.renderCard(card);
            });
            Y.Mashups.FlashMessage.message.hide();
        },

        updateEstimate : function(swimlane, estimate) {
            if (estimate == null || estimate == undefined) return;
            swimlane.estimate = swimlane.estimate + estimate;
            Y.one("#" + swimlane.headerID()).one(".estimate").set("innerHTML", swimlane.estimate);
            Y.one("#" + swimlane.footerID()).one(".estimate").set("innerHTML", swimlane.estimate);
        }
    });
    Y.Mashups.Swimlanes = Swimlanes;


}, '1.0', {requires: ['base','node','io','json','dd','cookie','collection','mashups-global','mashups-service']});YUI.add('mashups-service', function(Y) {
    Y.namespace('Mashups');

    function Service(config) {
        Service.superclass.constructor.apply(this, arguments);
    }

    Service.NAME = 'service';
    Service.ATTRS = {
        mashupName: {value: null},
        filterType: {value: null},
        refreshCardsCallback: {value: null},
        beforeCardUpdateHook: {value: null}
    };

    Y.extend(Service, Y.Base, {
        initializer : function(config) {
            this.batchToolkit = new RALLY.Mashup.BatchToolkit('__WORKSPACE_OID__', '__PROJECT_OID__', '__PROJECT_SCOPING_UP__', '__PROJECT_SCOPING_DOWN__');
        },

        execute : function(url, config) {
            Y.io(url, config);
        },

        findOwnerNameByEmailId : function(card) {
            var url = '/slm/webservice/1.14/user.js?query=(EmailAddress = ' + card.Owner + ' )';
            var config = {
                method: 'GET',
                headers: { 'Content-Type': 'application/json; charset=utf-8' },
                on: {
                    success: function (x, o, card) {
                        var ownerName = null;
                        var response = Y.JSON.parse(o.responseText);
                        var ownerObject = response['QueryResult']['Results'][0];
                        if (ownerObject != null) {
                            ownerName = ownerObject['_refObjectName'];
                        }
                        card.updateOwnerName(ownerName);
                    }
                },
                arguments: card
            };

            this.execute(url, config);
        },

        loadFilter: function() {
            Y.Mashups.FlashMessage.message.show("Please wait... loading filter options");
            this.filterDropdown = new RALLY.Mashup.Dropdown(this.batchToolkit, this.get('filterType'), "filter-dropdown", "filter-label", 'mu_iteration_status');
            this.filterDropdown.invoke(this.get("refreshCardsCallback"));
            Y.Mashups.FlashMessage.message.show("Please wait... loading swimlanes");
        },

        findCardsByFilter: function(callback) {
            Y.Mashups.FlashMessage.message.show("Please wait... loading cards for '" + this.filterDropdown.getSelectedName() + "'");
            var queryArr = [];
            var fields = "FormattedID,Name,ObjectID,ScheduleState,PlanEstimate,Owner,KanbanState,Blocked,Iteration,Rank";
            queryArr[0] =
            {
                key: 'defects',
                type: 'defect',
                fetch: fields,
                order: "Rank",
                query: "(" + this.get('filterType') + ".Name = " + "\"" + this.filterDropdown.getSelectedName() + "\")"
            };

            queryArr[1] =
            {
                key: "stories",
                type: "hierarchicalrequirement",
                fetch: fields,
                order: "Rank",
                query: "(" + this.get('filterType') + ".Name = " + "\"" + this.filterDropdown.getSelectedName() + "\")"
            };

            this.batchToolkit.findAll(queryArr, function(results) {
                var cards = new Y.Mashups.Cards();
                Y.each(results.stories, function(story) {
                    cards.addCard(new Y.Mashups.Story(story));
                });
                Y.each(results.defects, function(defect) {
                    cards.addCard(new Y.Mashups.Defect(defect));
                });
                if (cards.noOfCards() == 0){ Y.Mashups.FlashMessage.message.show("No cards found"); return; }
                callback(cards);
            });
        },

        updateCard : function(card, dataAsJSON, callback) {
            if (callback == undefined || callback == null) callback = this.get("refreshCardsCallback");

            var beforeCardUpdateHook = this.get('beforeCardUpdateHook');
            if (beforeCardUpdateHook != null) {
                dataAsJSON = beforeCardUpdateHook(card, dataAsJSON);
            }
            var url = '/slm/webservice/1.14/' + card.get('rallyType') + '/' + card.ObjectID + ".js";
            var config = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json; charset=utf-8' },
                data: dataAsJSON,
                on: {
                    success: function (ioId, o, callback) {
                        var response = Y.JSON.parse(o.responseText);
                        if (response['OperationResult']['Errors'].length > 0) {
                            Y.Mashups.FlashMessage.error.show('Failed updating state. \n Response:' + o.responseText);
                        } else {
                            Y.Mashups.FlashMessage.message.show("Card updated successfully.");
                        }
                        callback();
                    },
                    failure: function (ioId, o, callback) {
                        Y.Mashups.FlashMessage.error.show('Failed updating state. \n Response:' + o.responseText);
                        callback();
                    }
                },
                arguments: callback

            };

            this.execute(url, config);
        }

    });

    Y.Mashups.Service = Service;


}, '0.6', {requires: ['base','io']});
    </script>
</head>
<body>

<div class="outer-container yui-skin-sam">
    <div class="hide left" id="error-message"></div>
    <form action="#">
        <div class="navigation-bar">
            <div class="left">
                <div class="left" id="filter-label"></div>
                <div class="left"><select id="filter-dropdown"></select></div>
            </div>
            <div id="action-menu" class="hide left menu-bar yui-menu yui-menu-horizontal yui-menubuttonnav">
                <div class="yui-menu-content"><!-- Content box -->
                </div>
            </div>
            <div class="left" id="flash-message">Loading YUI Libraray....taking too long means no internet connection. please check proxy settings. </div>
            <div class="right"><a class="version" href="http://github.com/sunitparekh/rally-mashups/raw/master/README">Scrum Board v1.0</a></div>
        </div>
        <div class="swimlane-board">
            <div class="swimlane-header swimlane-row"></div>
            <div class="swimlane-cards swimlane-row"></div>
            <div class="swimlane-footer swimlane-row"></div>
        </div>
    </form>
</div>


<script type="text/javascript">
    var YahooUI = YUI().use('mashups-swimlane','mashups-card','mashups-service','mashups-action-menu', function (Y) {
        var service = null;
        var swimlanes = null;                                   

        function initPage() {
            Y.Mashups.FlashMessage.message.hide();
            service = new Y.Mashups.Service({mashupName: "DocumentationScrumBoard", refreshCardsCallback: Y.Mashups.DocumentationScrumBoard.refreshCardsOnBoard, filterType : RALLY.Mashup.ITERATION});
            swimlanes = Y.Mashups.DocumentationScrumBoard.loadSwimlaneBoard();
            Y.Mashups.DocumentationScrumBoard.loadActionMenu(swimlanes);
            service.loadFilter();
        }

        Y.namespace('Mashups.DocumentationScrumBoard');

        Y.Mashups.DocumentationScrumBoard.loadSwimlaneBoard = function() {
            var tempSwimlanes = Y.Mashups.DocumentationScrumBoard.KanbanStatesAsSwimlanes();
            tempSwimlanes.renderSwimlanes();
            return tempSwimlanes;
        };

        Y.Mashups.DocumentationScrumBoard.loadActionMenu = function(swimlanes) {
            var actionMenu = new Y.Mashups.ActionMenu({showSwimlane: false, hideSwimlane: false});
            actionMenu.buildMenu(swimlanes, service);
            actionMenu.show();
            return actionMenu;
        };

        Y.Mashups.DocumentationScrumBoard.refreshCardsOnBoard = function() {
            var cards = service.findCardsByFilter(Y.Mashups.DocumentationScrumBoard.renderCards);
        };

        Y.Mashups.DocumentationScrumBoard.renderCards = function(cards) {
            cards.sortByRank();
            swimlanes.renderCards(cards);
        };

        Y.Mashups.DocumentationScrumBoard.KanbanStatesAsSwimlanes = function() {
            return new Y.Mashups.Swimlanes({
                swimlaneNotAvailable : new Y.Mashups.Swimlane({ Name: "Undefined", Label: "No Defined State"}) ,
                service: service
            })
                .addSwimlane(new Y.Mashups.Swimlane({ Name: "Defined", Label: "Backlog", data : '{ "KanbanState": "Defined", "ScheduleState": "Backlog" }' }))
                .addSwimlane(new Y.Mashups.Swimlane({ Name: "Ready For Development", Label: "Defined", data : '{ "KanbanState": "Ready For Development", "ScheduleState": "Defined" }'  }))
                .addSwimlane(new Y.Mashups.Swimlane({ Name: "In Development", Label: "In Progress", data : '{ "KanbanState": "In Development", "ScheduleState": "In-Progress" }'  }))
                .addSwimlane(new Y.Mashups.Swimlane({ Name: "Ready For Code Review", Label: "Ready for Peer Review", data : '{ "KanbanState": "Ready For Code Review", "ScheduleState": "In-Progress" }'  }))
                .addSwimlane(new Y.Mashups.Swimlane({ Name: "In Code Review", Label: "In Peer Review", data : '{ "KanbanState": "In Code Review", "ScheduleState": "In-Progress" }'  }))
                .addSwimlane(new Y.Mashups.Swimlane({ Name: "Ready For Test", Label: "Ready for Technical Review", data : '{ "KanbanState": "Ready For Test", "ScheduleState": "In-Progress" }'  }))
                .addSwimlane(new Y.Mashups.Swimlane({ Name: "In Test" , Label: "In Technical Review", data : '{ "KanbanState": "In Test", "ScheduleState": "In-Progress" }' }))
                .addSwimlane(new Y.Mashups.Swimlane({ Name: "Ready For Acceptance", Label: "Ready For Acceptance", data : '{ "KanbanState": "Ready For Acceptance", "ScheduleState": "Completed" }'  }))
                .addSwimlane(new Y.Mashups.Swimlane({ Name: "Accepted" , Label: "Backlog", data : '{ "KanbanState": "Accepted", "ScheduleState": "Accepted" }' }));

        };

        initPage();
    });

    function refreshWindow(url, cardNumber, cardTitle, flag1, flag2, flag3){
        YahooUI.Mashups.DocumentationScrumBoard.refreshCardsOnBoard();
    }
    
</script>
</body>
</html>